<!DOCTYPE html>
<html>
<head>
    <style>
        @page { size: a4 portrait; margin: 1cm; }
        body { font-family: 'Helvetica', Arial, sans-serif; color: #334155; }

        /* Header Style */
        .header-container { text-align: center; margin-bottom: 20px; }
        .trip-name { font-size: 28px; font-weight: bold; color: #0f172a; text-transform: uppercase; margin: 0; }
        .header-line { border: 0; border-top: 2px solid #334155; width: 80%; margin: 10px auto; }
        .trip-meta { font-size: 13px; color: #64748b; font-weight: bold; }

        /* Summary Cards - Height Reduced & Darker Grey */
        .summary-table { width: 100%; border-collapse: separate; border-spacing: 10px 0; margin-bottom: 20px; }
        .card { 
            background: #e2e8f0; /* Darker Grey */
            border: 1px solid #cbd5e1; 
            padding: 10px; /* Height Reduced */
            border-radius: 8px; 
            text-align: center;
            border-bottom: 3px solid #94a3b8; /* 3D depth effect */
        }
        .card-label { font-size: 9px; color: #64748b; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; }
        .card-value { font-size: 18px; color: #0f172a; font-weight: bold; }

        .section-header { 
            font-size: 13px; font-weight: bold; color: #0f172a; 
            border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; 
            margin-top: 20px; margin-bottom: 10px; text-transform: uppercase; 
        }

        table.main-table { width: 100%; border-collapse: collapse; }
        table.main-table th { background-color: #f1f5f9; color: #475569; padding: 10px; font-size: 11px; text-align: left; border-bottom: 2px solid #cbd5e1; }
        table.main-table td { padding: 10px; font-size: 11px; border-bottom: 1px solid #f1f5f9; }

        /* 3D Slab for Graph */
        .chart-section { 
            text-align: center; 
            margin-top: 30px; 
            padding: 15px; 
            background: #f8fafc; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px;
            border-bottom: 5px solid #cbd5e1; /* 3D Slab Look */
            width: 70%;
            margin-left: auto;
            margin-right: auto;
        }
        .chart-title { font-size: 11px; font-weight: bold; color: #475569; margin-bottom: 10px; text-transform: uppercase; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: bold; }
        .get-back { background: #dcfce7; color: #166534; }
        .owe { background: #fee2e2; color: #991b1b; }

        .footer { margin-top: 30px; text-align: center; font-size: 9px; color: #94a3b8; border-top: 1px solid #f1f5f9; padding-top: 10px; }
    </style>
</head>
<body>

    <div class="header-container">
        <h1 class="trip-name">{{ trip.name }}</h1>
        <hr class="header-line">
        <p class="trip-meta">{{ trip.destination }} &bull; {{ trip.start_date }} to {{ trip.end_date }}</p>
    </div>

    <table class="summary-table">
        <tr>
            <td class="card">
                <div class="card-label">Total Expense</div>
                <div class="card-value">${{ total_expense|floatformat:2 }}</div>
            </td>
            <td class="card">
                <div class="card-label">Members</div>
                <div class="card-value">{{ members.count }}</div>
            </td>
            <td class="card">
                <div class="card-label">Per Person</div>
                <div class="card-value">${{ share|floatformat:2 }}</div>
            </td>
        </tr>
    </table>

    <div class="section-header">Trip Itinerary</div>
    <table class="main-table">
        <thead>
            <tr>
                <th width="20%">Date</th>
                <th width="30%">Location</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for stop in stops %}
            <tr>
                <td>{{ stop.date }}</td>
                <td><strong>{{ stop.location }}</strong></td>
                <td>{{ stop.notes|default:"-" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="section-header">Settlement Summary</div>
    <table class="main-table">
        <thead>
            <tr>
                <th>Member</th>
                <th>Paid</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for m in member_balances %}
            <tr>
                <td><strong>{{ m.name }}</strong></td>
                <td>${{ m.paid|floatformat:2 }}</td>
                <td>
                    {% if m.diff > 0 %} 
                        <span class="badge get-back">Collect: ${{ m.diff|floatformat:2 }}</span>
                    {% elif m.diff < 0 %} 
                        <span class="badge owe">Pay: ${{ m.diff|floatformat:2|cut:"-" }}</span> 
                    {% else %} 
                        <span style="color: #94a3b8;">Settled</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- 3D Slab Chart Section -->
    {% if chart_url %}
    <div class="chart-section">
        <div class="chart-title">Expense Breakdown AI Analysis</div>
        <img src="{{ chart_url }}" width="300">
    </div>
    {% endif %}

    <div class="footer">
        Generated by SmartTravel Manager &bull; {% now "F j, Y" %}
    </div>

</body>
</html>